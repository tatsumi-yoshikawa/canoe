<!-- <h1>index.html</h1> -->

<!-- <h2>Claude</h2> -->
<!-- 
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈáçÂäõ„Çπ„Ç±„ÉÉ„ÉÅ„Éú„Éº„Éâ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            overflow: hidden;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        #canvas {
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            cursor: crosshair;
            background: rgba(255, 255, 255, 0.03);
        }
        .controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 25px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        #clearBtn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        #clearBtn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }
        #gravityToggle {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        #gravityToggle:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }
        #gravityToggle.off {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .info {
            position: absolute;
            bottom: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button id="clearBtn">„ÇØ„É™„Ç¢</button>
        <button id="gravityToggle">ÈáçÂäõ: ON</button>
    </div>
    <canvas id="canvas"></canvas>
    <div class="info">„Éû„Ç¶„Çπ„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÊèèÁîª | Êèè„ÅÑ„ÅüÁ∑ö„ÅåÈáçÂäõ„ÅßËêΩ‰∏ã„Åó„Åæ„Åô</div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = Math.min(window.innerWidth - 40, 1200);
        canvas.height = Math.min(window.innerHeight - 120, 700);

        let particles = [];
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let gravityEnabled = true;
        let hue = 0;

        class Particle {
            constructor(x, y, vx, vy, color) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.color = color;
                this.life = 1;
                this.size = Math.random() * 3 + 2;
                this.gravity = 0.15;
                this.bounce = 0.7;
                this.friction = 0.99;
            }

            update() {
                if (gravityEnabled) {
                    this.vy += this.gravity;
                    this.vx *= this.friction;
                }

                this.x += this.vx;
                this.y += this.vy;

                // Â∫ä„Å®„ÅÆË°ùÁ™Å
                if (this.y + this.size > canvas.height) {
                    this.y = canvas.height - this.size;
                    this.vy *= -this.bounce;
                    this.vx *= this.friction;
                    
                    if (Math.abs(this.vy) < 0.5) {
                        this.vy = 0;
                    }
                }

                // Â£Å„Å®„ÅÆË°ùÁ™Å
                if (this.x + this.size > canvas.width || this.x - this.size < 0) {
                    this.vx *= -this.bounce;
                    this.x = this.x + this.size > canvas.width ? 
                             canvas.width - this.size : this.size;
                }

                // Â§©‰∫ï„Å®„ÅÆË°ùÁ™Å
                if (this.y - this.size < 0) {
                    this.y = this.size;
                    this.vy *= -this.bounce;
                }

                this.life -= 0.002;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.shadowBlur = 15;
                ctx.shadowColor = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        function createParticles(x, y, prevX, prevY) {
            const distance = Math.hypot(x - prevX, y - prevY);
            const steps = Math.max(1, Math.floor(distance / 5));
            
            for (let i = 0; i < steps; i++) {
                const t = i / steps;
                const px = prevX + (x - prevX) * t;
                const py = prevY + (y - prevY) * t;
                
                const angle = Math.atan2(y - prevY, x - prevX);
                const speed = Math.min(distance / 10, 5);
                
                const color = `hsl(${hue}, 100%, 60%)`;
                
                for (let j = 0; j < 2; j++) {
                    const vx = Math.cos(angle) * speed + (Math.random() - 0.5) * 2;
                    const vy = Math.sin(angle) * speed + (Math.random() - 0.5) * 2;
                    particles.push(new Particle(px, py, vx, vy, color));
                }
            }
            
            hue += 0.5;
            if (hue > 360) hue = 0;
        }

        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            lastX = e.offsetX;
            lastY = e.offsetY;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            createParticles(e.offsetX, e.offsetY, lastX, lastY);
            lastX = e.offsetX;
            lastY = e.offsetY;
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isDrawing = false;
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            particles = [];
        });

        document.getElementById('gravityToggle').addEventListener('click', (e) => {
            gravityEnabled = !gravityEnabled;
            e.target.textContent = gravityEnabled ? 'ÈáçÂäõ: ON' : 'ÈáçÂäõ: OFF';
            e.target.classList.toggle('off', !gravityEnabled);
        });

        function animate() {
            ctx.fillStyle = 'rgba(26, 26, 46, 0.15)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            particles = particles.filter(p => p.life > 0);

            particles.forEach(particle => {
                particle.update();
                particle.draw();
            });

            requestAnimationFrame(animate);
        }

        animate();

        window.addEventListener('resize', () => {
            canvas.width = Math.min(window.innerWidth - 40, 1200);
            canvas.height = Math.min(window.innerHeight - 120, 700);
        });
    </script>
</body>
</html> -->










<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Emoji Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;800&display=swap" rel="stylesheet">
    <!-- FontAwesome („Ç¢„Ç§„Ç≥„É≥Áî®) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --glass-bg: rgba(255, 255, 255, 0.9); --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2); }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'M PLUS Rounded 1c', sans-serif; overflow: hidden; background-color: #f0f0f0; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* UI„Ç≥„É≥„ÉÜ„Éä */
        .ui-container {
            position: absolute; top: 50%; right: 20px; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 15px; z-index: 1000;
            background: var(--glass-bg); backdrop-filter: blur(10px); padding: 20px;
            border-radius: 30px; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.5);
        }
        .emoji-btn {
            background: white; border: 2px solid #fff; border-radius: 50%; width: 60px; height: 60px;
            font-size: 32px; cursor: pointer; transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative; outline: none;
        }
        .emoji-btn:hover { transform: scale(1.2); z-index: 10; }
        .emoji-btn:active { transform: scale(0.9); }
        .emoji-btn::after {
            content: attr(data-label); position: absolute; right: 75px; background: rgba(0,0,0,0.8);
            color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; opacity: 0;
            pointer-events: none; transition: opacity 0.2s; white-space: nowrap; font-weight: bold;
        }
        .emoji-btn:hover::after { opacity: 1; }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .map-emoji-icon {
            font-size: 40px; text-align: center; line-height: 1;
            animation: bounceIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transition: all 1s ease-out; cursor: default; text-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        @keyframes bounceIn { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .fade-out { opacity: 0; transform: scale(1.5) translateY(-30px); filter: blur(2px); }

        /* „Çø„Ç§„Éà„É´ */
        .title-card {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: var(--glass-bg); padding: 12px 24px; border-radius: 50px;
            box-shadow: var(--shadow); backdrop-filter: blur(5px); display: flex; align-items: center; gap: 12px;
        }
        .title-card h1 { margin: 0; font-size: 1.4rem; color: #333; }
        .status-dot { width: 12px; height: 12px; background-color: #bdc3c7; border-radius: 50%; transition: 0.3s; }
        .status-connected { background-color: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
        .status-error { background-color: #e74c3c; box-shadow: 0 0 8px #e74c3c; }

        /* GPS„Éú„Çø„É≥ */
        .gps-btn {
            position: absolute; bottom: 30px; left: 20px; z-index: 1000;
            background: white; width: 50px; height: 50px; border-radius: 50%; border: none;
            box-shadow: var(--shadow); cursor: pointer; font-size: 20px; color: #555;
            display: flex; justify-content: center; align-items: center; transition: 0.2s;
        }
        .gps-btn:hover { background-color: #f8f9fa; color: #2ecc71; }

        @media (max-width: 600px) {
            .ui-container { top: auto; bottom: 30px; right: 50%; transform: translateX(50%); flex-direction: row; width: 85%; justify-content: space-around; padding: 15px; }
            .emoji-btn::after { display: none; }
            .leaflet-control-zoom { margin-bottom: 100px !important; }
            .gps-btn { bottom: 120px; left: auto; right: 10px; } /* „Çπ„Éû„Éõ„Åß„ÅÆ‰ΩçÁΩÆË™øÊï¥ */
        }
    </style>
</head>
<body>

    <div class="title-card">
        <div id="statusDot" class="status-dot" title="ÈÄö‰ø°Áä∂ÊÖã"></div>
        <h1>Global Emoji Map üåè</h1>
    </div>

    <div id="map"></div>

    <!-- ÁèæÂú®Âú∞„Å∏ÁßªÂãï„Éú„Çø„É≥ -->
    <button class="gps-btn" onclick="flyToCurrentLocation()" title="ÁèæÂú®Âú∞„Å∏ÁßªÂãï">
        <i class="fa-solid fa-location-crosshairs"></i>
    </button>

    <div class="ui-container">
        <button class="emoji-btn" data-label="ÊôÆÈÄö" onclick="handleClick('üòê')">üòê</button>
        <button class="emoji-btn" data-label="„Åæ„ÅÇ„Åæ„ÅÇ" onclick="handleClick('üôÇ')">üôÇ</button>
        <button class="emoji-btn" data-label="ËâØ„ÅÑ" onclick="handleClick('üòÑ')">üòÑ</button>
        <button class="emoji-btn" data-label="ÊúÄÈ´òÔºÅ" onclick="handleClick('üòç')">üòç</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <script>
        // --- Ë®≠ÂÆö ---
        const FADE_OUT_TIME = 3000;
        const MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt';
        const MQTT_TOPIC = 'demo/global-emoji-map/v2';
        const MY_ID = 'user_' + Math.random().toString(36).substring(7);

        // --- Âú∞Âõ≥ÂàùÊúüÂåñ ---
        const map = L.map('map', { zoomControl: false }).setView([35.6895, 139.6917], 3);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 20
        }).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // --- MQTTÊé•Á∂ö ---
        const statusDot = document.getElementById('statusDot');
        const client = mqtt.connect(MQTT_BROKER, { clientId: MY_ID, clean: true, reconnectPeriod: 1000 });

        client.on('connect', () => {
            console.log('‚úÖ MQTT Connected!');
            statusDot.className = 'status-dot status-connected';
            client.subscribe(MQTT_TOPIC);
        });
        client.on('error', (err) => {
            console.error('‚ùå MQTT Error:', err);
            statusDot.className = 'status-dot status-error';
        });
        client.on('message', (topic, message) => {
            if (topic === MQTT_TOPIC) {
                try {
                    const data = JSON.parse(message.toString());
                    if (data.senderId === MY_ID) return;
                    showOnMap(data.lat, data.lon, data.emoji);
                } catch (e) { console.error(e); }
            }
        });

        // --- „ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆÂá¶ÁêÜ ---
        async function handleClick(emoji) {
            playPopSound();
            
            // ‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÊ±∫ÂÆö„É≠„Ç∏„ÉÉ„ÇØ
            let lat, lon;
            
            // 1. „Åæ„ÅöGPSÊÉÖÂ†±„ÅÆÂèñÂæó„ÇíË©¶„Åø„Çã
            const gpsLoc = await tryGetGPS();

            if (gpsLoc) {
                // GPS„ÅåÂèñ„Çå„Åü„Çâ„Åù„Çå„Çí‰Ωø„ÅÜ
                lat = gpsLoc.lat;
                lon = gpsLoc.lon;
            } else {
                // GPS„Åå„ÉÄ„É°„Å™„Çâ„ÄåÁèæÂú®„ÅÆÂú∞Âõ≥„ÅÆ‰∏≠ÂøÉ„Äç„Çí‰Ωø„ÅÜÔºà„Åì„Åì„ÅåÈáçË¶ÅÔºÅÔºâ
                const center = map.getCenter();
                lat = center.lat;
                lon = center.lng;
                
                // ÂàùÂõû„Å†„Åë„É¶„Éº„Ç∂„Éº„Å´ÈÄöÁü•Ôºà‰ªªÊÑèÔºâ
                console.log("GPS„ÅåÂèñÂæó„Åß„Åç„Å™„ÅÑ„Åü„ÇÅ„ÄÅÂú∞Âõ≥„ÅÆ‰∏≠ÂøÉ‰ΩçÁΩÆ„Çí‰ΩøÁî®„Åó„Åæ„Åó„Åü");
            }

            // Â∞ë„Åó„É©„É≥„ÉÄ„É†„Å´„Åö„Çâ„ÅôÔºàÈáç„Å™„ÇäÈò≤Ê≠¢Ôºâ
            const finalLoc = addJitter(lat, lon);

            // Ë°®Á§∫ & ÈÄÅ‰ø°
            showOnMap(finalLoc.lat, finalLoc.lon, emoji);
            
            if (client.connected) {
                client.publish(MQTT_TOPIC, JSON.stringify({
                    senderId: MY_ID, lat: finalLoc.lat, lon: finalLoc.lon, emoji: emoji
                }));
            }
        }

        // --- GPSÂèñÂæó„É≠„Ç∏„ÉÉ„ÇØÔºàÁü≠ÊôÇÈñì„ÅßË´¶„ÇÅ„ÇãÔºâ ---
        let cachedGPS = null;

        function tryGetGPS() {
            return new Promise((resolve) => {
                if (cachedGPS) { resolve(cachedGPS); return; }
                if (!navigator.geolocation) { resolve(null); return; }

                // 2ÁßíÂæÖ„Å£„Å¶„ÉÄ„É°„Å™„Çânull„ÇíËøî„ÅôÔºàÔºùÂú∞Âõ≥„ÅÆ‰∏≠ÂøÉ„Çí‰Ωø„ÅÜÔºâ
                const timeoutId = setTimeout(() => { resolve(null); }, 2000);

                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        clearTimeout(timeoutId);
                        cachedGPS = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                        resolve(cachedGPS);
                    },
                    (err) => {
                        clearTimeout(timeoutId);
                        // „Ç®„É©„ÉºÊôÇ„ÅØnull„ÇíËøî„Åô
                        resolve(null);
                    },
                    { enableHighAccuracy: true, timeout: 2000, maximumAge: 60000 }
                );
            });
        }

        // --- „ÄåÁèæÂú®Âú∞„Å∏ÁßªÂãï„Äç„Éú„Çø„É≥Ê©üËÉΩ ---
        function flyToCurrentLocation() {
            if (!navigator.geolocation) { alert("„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì"); return; }
            
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    map.flyTo([lat, lon], 15, { duration: 2 });
                    cachedGPS = { lat, lon }; // „Ç≠„É£„ÉÉ„Ç∑„É•Êõ¥Êñ∞
                },
                (err) => {
                    alert("‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\nPCË®≠ÂÆö„Åæ„Åü„ÅØ„Éñ„É©„Ç¶„Ç∂Ë®≠ÂÆö„Åß‰ΩçÁΩÆÊÉÖÂ†±„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                },
                { enableHighAccuracy: true }
            );
        }

        function addJitter(lat, lon) {
            // „Ç∫„É¨ÂπÖ„ÇíÂ∞è„Åï„Åè„Åó„Åæ„Åó„ÅüÔºàÔºë„Åß100kmÔºâ
            const jitter = 0.01; 
            return {
                lat: lat + (Math.random() - 0.5) * jitter,
                lon: lon + (Math.random() - 0.5) * jitter
            };
        }

        function showOnMap(lat, lon, emoji) {
            const iconDiv = L.divIcon({
                html: `<div class="map-emoji-icon">${emoji}</div>`,
                className: '', iconSize: [40, 40], iconAnchor: [20, 20]
            });
            const marker = L.marker([lat, lon], { icon: iconDiv }).addTo(map);
            setTimeout(() => { 
                const el = marker.getElement();
                if(el) el.querySelector('.map-emoji-icon')?.classList.add('fade-out');
            }, FADE_OUT_TIME);
            setTimeout(() => map.removeLayer(marker), FADE_OUT_TIME + 1000);
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playPopSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.15);
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.2);
        }
    </script>
</body>
</html>